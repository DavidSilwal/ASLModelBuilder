@page "/camera"
@inject HttpClient Client
@inject IJSRuntime JsRuntime

<div class="video-wrap">
    <video id="video" playsinline autoplay></video>
</div>

<div class="controller">
    <button @onclick="StartCamera">Start Camera</button>
    <button @onclick="Snap">Capture</button>
    <button @onclick="DeleteLetter">Delete</button>
</div>

<div>
    <p class="display-4">@DisplayText</p>
</div>

<div>
    <canvas id="capturedImage" width="640" height="480"></canvas>
</div>

@code {
    private List<string> capturedText;
    private string DisplayText;

    protected override async Task OnInitializedAsync()
    {
        DisplayText = "";
        capturedText = new List<string>();
    }

    private async Task StartCamera()
    {
        await JsRuntime.InvokeVoidAsync("Initialize", new Dictionary<string, string>
        {
                {"video", "video"}
        });
    }


    // Take a picture
    private async Task Snap()
    {
        Console.WriteLine("Taking picture");
        await JsRuntime.InvokeVoidAsync("Snap", "video", "capturedImage");

        var imageBytes = await JsRuntime.InvokeAsync<string>("GetImageData", "capturedImage", "image/jpeg");
        var json = JsonSerializer.Serialize(new Dictionary<string, string> { { "data", imageBytes } });

        var req = await Client.PostAsync("https://localhost:44330/api/prediction", new StringContent(json, Encoding.UTF8, "application/json"));
        var res = await req.Content.ReadAsStringAsync();
        var body = JsonSerializer.Deserialize<PredictionResponse>(res);

        AddLetter(body.Prediction);

        Console.WriteLine(capturedText.Count);

        foreach(var el in capturedText)
        {
            Console.WriteLine(el);
        }

        DisplayText = $"Text: {string.Join("",capturedText)}";
    }

    private void AddLetter(string letter)
    {
        capturedText.Add(letter);
    }

    private void DeleteLetter()
    {
        if(capturedText.Count > 0)
        {
            capturedText.RemoveAt(capturedText.Count - 1);
            DisplayText = $"Text: {string.Join("", capturedText)}";
        }

    }

    class PredictionResponse
    {
        [JsonPropertyName("prediction")]
        public string Prediction { get; set; }
    }
}
